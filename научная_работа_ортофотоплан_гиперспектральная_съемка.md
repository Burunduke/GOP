# Разработка методики создания ортофотопланов на основе гиперспектральной съемки и анализ состояния растений с использованием вегетационных индексов

---

## Титульная страница

**САНКТ-ПЕТЕРБУРГСКИЙ ГОСУДАРСТВЕННЫЙ УНИВЕРСИТЕТ**

**Институт наук о Земле**

**Кафедра картографии и геоинформатики**

**ИНДЫКОВ ДМИТРИЙ АНДРЕЕВИЧ**

**РАЗРАБОТКА МЕТОДИКИ СОЗДАНИЯ ОРТОФОТОПЛАНОВ НА ОСНОВЕ ГИПЕРСПЕКТРАЛЬНОЙ СЪЕМКИ И АНАЛИЗ СОСТОЯНИЯ РАСТЕНИЙ С ИСПОЛЬЗОВАНИЕМ ВЕГЕТАЦИОННЫХ ИНДЕКСОВ**

**Магистерская диссертация**

Направление подготовки 05.03.03 «Картография и геоинформатика»

**Научный руководитель:**
доцент кафедры картографии и геоинформатики,
кандидат географических наук
Митрофанов Евгений Павлович

**Рецензент:**
ведущий научный сотрудник,
доктор технических наук
Петрушин Алексей Федорович

**Санкт-Петербург**
**2024**

---

## Аннотация

**Русский язык:**
В работе представлена комплексная методика создания ортофотопланов на основе данных гиперспектральной съемки, полученных с беспилотных летательных аппаратов (БПЛА), и анализа состояния растительности с использованием вегетационных индексов. Исследование направлено на разработку эффективного пайплайна обработки гиперспектральных данных с использованием открытого программного обеспечения, включая OpenDroneMap, GDAL и Python-библиотеки. Разработана методика сегментации изображений сверхвысокого разрешения с использованием моделей DeepLabV3+ и Continuous refinement model. Представлен анализ вегетационных индексов для оценки состояния растений, включая индексы озеленения, поглощения света и насыщения водой. Результаты исследования демонстрируют возможность создания качественных ортофотопланов и точной оценки состояния растений для задач сельского хозяйства, экологического мониторинга и точного земледелия.

**English:**
This paper presents a comprehensive methodology for creating orthophoto maps based on hyperspectral imaging data obtained from unmanned aerial vehicles (UAVs) and analyzing vegetation condition using vegetation indices. The research focuses on developing an efficient hyperspectral data processing pipeline using open-source software, including OpenDroneMap, GDAL, and Python libraries. A methodology for segmenting ultra-high-resolution images using DeepLabV3+ and Continuous refinement model has been developed. An analysis of vegetation indices for assessing plant condition is presented, including greenness indices, light absorption indices, and water saturation indices. The results demonstrate the feasibility of creating high-quality orthophoto maps and accurate assessment of plant condition for agricultural, environmental monitoring, and precision farming applications.

**Ключевые слова:** гиперспектральная съемка, ортофотоплан, БПЛА, вегетационные индексы, сегментация изображений, OpenDroneMap, точное земледелие, DeepLabV3+, обработка данных.

**Keywords:** hyperspectral imaging, orthophoto map, UAV, vegetation indices, image segmentation, OpenDroneMap, precision farming, DeepLabV3+, data processing.

---

## Оглавление

[Введение](#введение)

[Глава 1. Теоретические основы гиперспектральной съемки и анализа состояния растений](#глава-1-теоретические-основы-гиперспектральной-съемки-и-анализа-состояния-растений)
- [1.1. Гиперспектральная съемка: принципы и возможности](#11-гиперспектральная-съемка-принципы-и-возможности)
- [1.2. Вегетационные индексы: классификация и применение](#12-вегетационные-индексы-классификация-и-применение)
- [1.3. Современные методы сегментации изображений сверхвысокого разрешения](#13-современные-методы-сегментации-изображений-сверхвысокого-разрешения)

[Глава 2. Методика исследования](#глава-2-методика-исследования)
- [2.1. Общая архитектура пайплайна обработки данных](#21-общая-архитектура-пайплайна-обработки-данных)
- [2.2. Предварительная обработка гиперспектральных данных](#22-предварительная-обработка-гиперспектральных-данных)
- [2.3. Создание ортофотоплана на основе OpenDroneMap](#23-создание-ортофотоплана-на-основании-opendronemap)
- [2.4. Сегментация изображений сверхвысокого разрешения](#24-сегментация-изображений-сверхвысокого-разрешения)
- [2.5. Расчет вегетационных индексов и анализ состояния растений](#25-расчет-вегетационных-индексов-и-анализ-состояния-растений)

[Глава 3. Математические модели и алгоритмы](#глава-3-математические-модели-и-алгоритмы)
- [3.1. Математические модели вегетационных индексов](#31-математические-модели-вегетационных-индексов)
- [3.2. Алгоритмы сегментации изображений](#32-алгоритмы-сегментации-изображений)
- [3.3. Методы оценки качества сегментации](#33-методы-оценки-качества-сегментации)

[Глава 4. Экспериментальная часть](#глава-4-экспериментальная-часть)
- [4.1. Описание экспериментальных данных](#41-описание-экспериментальных-данных)
- [4.2. Валидация методики создания ортофотопланов](#42-валидация-методики-создания-ортофотопланов)
- [4.3. Анализ результатов сегментации](#43-анализ-результатов-сегментации)
- [4.4. Оценка точности вегетационных индексов](#44-оценка-точности-вегетационных-индексов)

[Глава 5. Экономическая эффективность и практическое применение](#глава-5-экономическая-эффективность-и-практическое-применение)
- [5.1. Экономическая эффективность использования гиперспектральной съемки](#51-экономическая-эффективность-использования-гиперспектральной-съемки)
- [5.2. Практические примеры применения методики](#52-практические-примеры-применения-методики)

[Глава 6. Ограничения и пути их преодоления](#глава-6-ограничения-и-пути-их-преодоления)
- [6.1. Технические ограничения](#61-технические-ограничения)
- [6.2. Методологические ограничения](#62-методологические-ограничения)
- [6.3. Пути преодоления ограничений](#63-пути-преодоления-ограничений)

[Глава 7. Результаты и обсуждение](#глава-7-результаты-и-обсуждение)
- [7.1. Основные результаты исследования](#71-основные-результаты-исследования)
- [7.2. Сравнение с существующими решениями](#72-сравнение-с-существующими-решениями)
- [7.3. Обсуждение результатов](#73-обсуждение-результатов)

[Заключение](#заключение)

[Перспективы развития](#перспективы-развития)

[Список литературы](#список-литературы)

[Приложения](#приложения)

---

## Введение

Стремительное развитие технологий дистанционного зондирования Земли в последние годы привело к появлению новых возможностей для мониторинга сельскохозяйственных угодий. Особое место среди этих технологий занимает гиперспектральная съемка, позволяющая получать детальную информацию о состоянии объектов в сотнях узких спектральных каналов. В сочетании с беспилотными летательными аппаратами (БПЛА) эта технология открывает новые перспективы для точного земледелия и мониторинга окружающей среды.

Актуальность исследования обусловлена несколькими факторами. Во-первых, согласно исследованиям рынка, ожидается, что общий объем искусственного интеллекта в сельском хозяйстве вырастет с 1 млрд долларов США в 2020 году до 4 млрд долларов США в 2026 году при совокупном годовом темпе роста 25,5% [1]. Во-вторых, своевременное внесение удобрений и пестицидов на основе анализа гиперспектральных данных позволяет увеличить чистую прибыль на 25,6-38,6 долларов США/га при сохранении или даже увеличении урожайности [2]. В-третьих, использование технологий точного земледелия позволяет снизить применение удобрений до 80%, а пестицидов до 60%, при увеличении урожая до 62% [3].

Основной проблемой обработки гиперспектральных данных является их большой объем и сложность геометрической коррекции. Традиционные фотограмметрические пакеты, такие как Metashape, часто не поддерживают работу с гиперспектральными данными в формате BIL/HDR, что требует разработки специализированных методик обработки. Кроме того, анализ состояния растений на основе гиперспектральных данных требует разработки эффективных методов сегментации изображений сверхвысокого разрешения и расчета вегетационных индексов.

**Цель исследования:** разработка комплексной методики создания ортофотопланов на основе гиперспектральной съемки с БПЛА и анализа состояния растений с использованием вегетационных индексов.

**Задачи исследования:**
1. Проанализировать существующие методы обработки гиперспектральных данных и создания ортофотопланов
2. Разработать пайплайн преобразования данных из формата BIL/HDR в ортофотоплан с использованием открытого программного обеспечения
3. Адаптировать современные методы сегментации изображений сверхвысокого разрешения для обработки ортофотопланов
4. Систематизировать и оптимизировать расчет вегетационных индексов для оценки состояния растений
5. Провести валидацию разработанной методики на экспериментальных данных
6. Оценить экономическую эффективность предложенного решения

**Научная новизна исследования заключается в:**
- Разработке комплексного пайплайна обработки гиперспектральных данных с использованием исключительно открытого программного обеспечения
- Адаптации каскадной модели сегментации изображений сверхвысокого разрешения для обработки ортофотопланов
- Систематизации вегетационных индексов по функциональным группам и разработке методики их комплексного применения

**Практическая значимость исследования состоит в том, что разработанная методика позволяет снизить затраты на обработку гиперспектральных данных и повысить точность оценки состояния растений, что способствует повышению эффективности сельскохозяйственного производства.

---

## Глава 1. Теоретические основы гиперспектральной съемки и анализа состояния растений

### 1.1. Гиперспектральная съемка: принципы и возможности

Гиперспектральная съемка представляет собой метод дистанционного зондирования, позволяющий получать информацию об объектах в сотнях узких спектральных каналов. В отличие от традиционной мультиспектральной съемки, которая обычно использует 3-10 широких спектральных каналов, гиперспектральные сенсоры обеспечивают непрерывный спектральный охват в видимом и ближнем инфракрасном диапазонах (обычно 400-2500 нм) с разрешением 1-10 нм.

Основные преимущества гиперспектральной съемки:
- **Высокое спектральное разрешение:** позволяет детектировать тонкие различия в спектральных характеристиках объектов
- **Идентификация материалов:** возможность различать материалы со схожими отражательными способностями в широких диапазонах
- **Количественный анализ:** возможность оценки биохимических параметров растений (содержание хлорофилла, воды, азота и др.)

Принцип работы гиперспектральных камер основан на дисперсии света с помощью дифракционных решеток или призм, что позволяет разделить incoming свет на узкие спектральные полосы. Современные гиперспектральные камеры, такие как PIKaL или Resonon, могут иметь от 100 до 300 спектральных каналов.

При использовании БПЛА в качестве платформы для гиперспектральной съемки достигается высокое пространственное разрешение (обычно 1-10 см/пиксель), что позволяет детально анализировать состояние отдельных растений и даже их частей.

### 1.2. Вегетационные индексы: классификация и применение

Вегетационные индексы представляют собой математические комбинации спектральных отражений в различных диапазонах, которые позволяют количественно оценивать различные характеристики растительности. Существует множество вегетационных индексов, которые можно классифицировать по их функциональному назначению:

**Индексы озеленения (Greenness indices):**
- NDVI (Normalized Difference Vegetation Index) - стандартный индекс для оценки общей зеленой биомассы
- GNDVI (Green Normalized Difference Vegetation Index) - более чувствителен к содержанию хлорофилла
- OSAVI (Optimized Soil Adjusted Vegetation Index) - учитывает влияние почвы
- MCARI (Modified Chlorophyll Absorption Ratio Index) - оценивает содержание хлорофилла

**Индексы поглощения света (Light absorption indices):**
- SIPI2 (Structure Insensitive Pigment Index) - оценивает соотношение каротиноидов к хлорофиллу
- mARI (modified Anthocyanin Reflectance Index) - определяет содержание антоцианов

**Индексы насыщения водой (Water content indices):**
- NDWI (Normalized Difference Water Index) - оценивает содержание воды в растениях
- MSI (Moisture Stress Index) - индекс водного стресса

Выбор индексов зависит от конкретной задачи, типа растительности, условий съемки и характеристик сенсора. Для комплексной оценки состояния растений рекомендуется использовать комбинацию индексов из разных функциональных групп.

### 1.3. Современные методы сегментации изображений сверхвысокого разрешения

Сегментация изображений является ключевым этапом при обработке ортофотопланов сверхвысокого разрешения (10000×10000 пикселей и более). Основные методы сегментации можно разделить на классические и основанные на глубоком обучении.

**Классические методы:**
- Пороговая обработка на основе вегетационных индексов
- Методы кластеризации (k-means, DBSCAN)
- Алгоритмы на основе градиентов (Canny, Sobel)
- Методы суперпикселей (SLIC, SEEDS)

**Методы на основе глубокого обучения:**
- FCN (Fully Convolutional Networks)
- U-Net
- SegNet
- DeepLab (с использованием сверток atrous)
- Mask R-CNN

Для обработки изображений сверхвысокого разрешения наиболее эффективными являются каскадные подходы, сочетающие предварительную сегментацию на сжатом изображении с последующим уточнением границ на исходном разрешении. Такой подход позволяет значительно снизить вычислительные затраты при сохранении высокой точности сегментации.

---

## Глава 2. Методика исследования

### 2.1. Общая архитектура пайплайна обработки данных

Разработанная методика включает следующие основные этапы:

1. **Предварительная обработка гиперспектральных данных:**
   - Конвертация данных из формата BIL/HDR в TIFF
   - Радиометрическая коррекция и шумоподавление
   - Геопривязка снимков по GPS-данным

2. **Создание ортофотоплана:**
   - Обработка в OpenDroneMap
   - Создание бесшовной ортомозаики
   - Экспорт в GeoTIFF формат

3. **Сегментация изображений:**
   - Предварительная сегментация с помощью DeepLabV3+
   - Уточнение границ с помощью Continuous refinement model
   - Выбор оптимальной маски сегментации

4. **Расчет вегетационных индексов:**
   - Выбор индексов в зависимости от типа сенсора
   - Нормализация значений индексов
   - Комплексная оценка состояния растений

5. **Визуализация и анализ результатов:**
   - Создание карт распределения индексов
   - Интерактивный анализ состояния растений
   - Экспорт результатов

### 2.2. Предварительная обработка гиперспектральных данных

Первым этапом является преобразование гиперспектральных данных из формата BIL/HDR в формат, пригодный для фотограмметрической обработки. Основная последовательность действий:

```python
# Пример преобразования BIL в TIFF с использованием GDAL
import gdal
import numpy as np

# Чтение гиперспектрального файла
dataset = gdal.Open('hyperspectral.bil')

# Извлечение метаданных
cols = dataset.RasterXSize
rows = dataset.RasterYSize
bands = dataset.RasterCount

# Извлечение отдельных спектральных каналов
for band in range(1, bands + 1):
    band_data = dataset.GetRasterBand(band)
    array = band_data.ReadAsArray()
    
    # Сохранение каждого канала в отдельный TIFF файл
    driver = gdal.GetDriverByName('GTiff')
    output = driver.Create(f'band_{band}.tif', cols, rows, 1, band_data.DataType)
    output.GetRasterBand(1).WriteArray(array)
    
    # Копирование геопривязки
    output.SetGeoTransform(dataset.GetGeoTransform())
    output.SetProjection(dataset.GetProjection())
    
    output = None
```

Радиометрическая коррекция включает калибровку по эталонным объектам и устранение атмосферных эффектов. Для шумоподавления применяются фильтры на основе анализа главных компонент (PCA) или вейвлет-преобразований.

### 2.3. Создание ортофотоплана на основе OpenDroneMap

OpenDroneMap (ODM) представляет собой полноценный пайплайн обработки аэрофотоснимков, поддерживающий автоматическую геопривязку по GPS-данным, построение плотных облаков точек, создание цифровых моделей рельефа (ЦМР) и генерацию ортофотопланов.

Основные этапы обработки в ODM:

1. **Подготовка данных:**
   - Размещение TIFF-файлов и GPS-координат в структурированных папках
   - Создание файла с GPS-координатами в формате ODM

2. **Запуск обработки:**
   ```bash
   ./run.sh --project-path /path/to/project \
            --orthophoto-resolution 0.05 \
            --dem-resolution 0.1 \
            --feature-quality high \
            --matcher-neighbors 8 \
            --use-exif false \
            --gps-file /path/to/gps.txt
   ```

3. **Настройка параметров:**
   - Установка разрешения ортофотоплана
   - Выбор качества обработки
   - Настройка методов сшивки

4. **Экспорт результатов:**
   - Получение ортофотоплана в формате GeoTIFF
   - Экспорт дополнительных продуктов (ЦМР, облако точек)

### 2.4. Сегментация изображений сверхвысокого разрешения

Для сегментации изображений сверхвысокого разрешения используется каскадный подход, включающий два основных этапа:

**Этап 1: Предварительная сегментация с помощью DeepLabV3+**

DeepLabV3+ улучшает FCN, используя свертку atrous, которая добавляет отверстия, благодаря чему сверточный вывод содержит больший диапазон информации и сохраняет пространственные особенности изображения.

```python
import torch
import torchvision.models as models
from torchvision import transforms

# Загрузка предобученной модели DeepLabV3+
model = models.segmentation.deeplabv3_resnet101(pretrained=True)
model.eval()

# Предобработка изображения
preprocess = transforms.Compose([
    transforms.ToPILImage(),
    transforms.Resize((512, 512)),
    transforms.ToTensor(),
    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
])

# Сегментация изображения
input_tensor = preprocess(image)
input_batch = input_tensor.unsqueeze(0)

with torch.no_grad():
    output = model(input_batch)['out']

# Постобработка результата
seg_map = torch.argmax(output.squeeze(), dim=0).detach().cpu().numpy()
```

**Этап 2: Уточнение границ с помощью Continuous refinement model**

CascadePSP использует каскадный подход для уточнения границ сегментации, сочетая глобальные и локальные шаги обработки.

```python
# Пример использования CascadePSP для уточнения границ
import cv2
import numpy as np

# Загрузка исходного изображения и грубой маски
image = cv2.imread('original_image.tif')
mask = cv2.imread('coarse_mask.png', 0)

# Уточнение границ
refined_mask = cascade_psp_refine(image, mask, L=500)

# Сохранение результата
cv2.imwrite('refined_mask.png', refined_mask)
```

### 2.5. Расчет вегетационных индексов и анализ состояния растений

Для расчета вегетационных индексов используется спектральная информация из ортофотоплана. Основные индексы, включенные в методику:

**Индексы озеленения:**
- GNDVI = (NIR - Green) / (NIR + Green)
- MCARI = ((RedEdge - Red) - 0.2 * (RedEdge - Green)) * (RedEdge / Red)
- MNLI = (NIR^2 - Red) / (NIR^2 + Red)
- OSAVI = (NIR - Red) / (NIR + Red + 0.16)
- TVI = 0.5 * (120 * (NIR - Green) - 200 * (Red - Green))

**Индексы поглощения света:**
- SIPI2 = (NIR - Blue) / (NIR - Red)
- mARI = (Green - Red) / (Green + Red)

**Индексы насыщения водой:**
- NDWI = (Green - NIR) / (Green + NIR)
- MSI = NIR / SWIR

```python
import numpy as np

def calculate_indices(image, sensor_type):
    """
    Расчет вегетационных индексов в зависимости от типа сенсора
    """
    # Извлечение спектральных каналов
    if sensor_type == 'RGB':
        blue = image[:, :, 0].astype(np.float32)
        green = image[:, :, 1].astype(np.float32)
        red = image[:, :, 2].astype(np.float32)
    elif sensor_type == 'Multispectral':
        blue = image[:, :, 0].astype(np.float32)
        green = image[:, :, 1].astype(np.float32)
        red = image[:, :, 2].astype(np.float32)
        red_edge = image[:, :, 3].astype(np.float32)
        nir = image[:, :, 4].astype(np.float32)
    elif sensor_type == 'Hyperspectral':
        # Выбор соответствующих каналов из гиперспектрального изображения
        blue = image[:, :, 10].astype(np.float32)  # ~450 нм
        green = image[:, :, 20].astype(np.float32)  # ~550 нм
        red = image[:, :, 30].astype(np.float32)   # ~650 нм
        red_edge = image[:, :, 35].astype(np.float32)  # ~720 нм
        nir = image[:, :, 50].astype(np.float32)   # ~800 нм
        swir = image[:, :, 80].astype(np.float32)  # ~1600 нм
    
    # Расчет индексов
    indices = {}
    
    # Индексы озеленения
    indices['GNDVI'] = (nir - green) / (nir + green + 1e-8)
    indices['MCARI'] = ((red_edge - red) - 0.2 * (red_edge - green)) * (red_edge / (red + 1e-8))
    indices['MNLI'] = (nir**2 - red) / (nir**2 + red + 1e-8)
    indices['OSAVI'] = (nir - red) / (nir + red + 0.16)
    indices['TVI'] = 0.5 * (120 * (nir - green) - 200 * (red - green))
    
    # Индексы поглощения света
    indices['SIPI2'] = (nir - blue) / (nir - red + 1e-8)
    indices['mARI'] = (green - red) / (green + red + 1e-8)
    
    # Индексы насыщения водой
    indices['NDWI'] = (green - nir) / (green + nir + 1e-8)
    indices['MSI'] = nir / (swir + 1e-8)
    
    return indices
```

Для комплексной оценки состояния растений используется нормализация значений индексов от 0 до 1 и их последующее усреднение по функциональным группам:

```python
def normalize_indices(indices, mask):
    """
    Нормализация значений индексов в области маски
    """
    normalized = {}
    
    for name, values in indices.items():
        # Применение маски
        masked_values = values[mask > 0]
        
        # Обрезка экстремальных значений
        if name in ['GNDVI', 'MCARI', 'MNLI', 'OSAVI', 'TVI']:
            # Индексы озеленения: значения от 0 до 1
            normalized[name] = np.clip(masked_values, 0, 1)
        elif name in ['SIPI2', 'mARI']:
            # Индексы поглощения света: инвертированная нормализация
            normalized[name] = 1 - np.clip(masked_values, 0, 1)
        elif name in ['NDWI', 'MSI']:
            # Индексы насыщения водой: нормализация в зависимости от типа
            if name == 'NDWI':
                normalized[name] = np.clip(masked_values, -1, 1) * 0.5 + 0.5
            else:  # MSI
                normalized[name] = 1 - np.clip(masked_values, 0, 2) * 0.5
    
    return normalized

def calculate_plant_condition(normalized_indices):
    """
    Расчет комплексной оценки состояния растений
    """
    # Усреднение индексов по группам
    greenness = np.mean([
        normalized_indices['GNDVI'],
        normalized_indices['MCARI'],
        normalized_indices['MNLI'],
        normalized_indices['OSAVI'],
        normalized_indices['TVI']
    ])
    
    stress = np.mean([
        normalized_indices['SIPI2'],
        normalized_indices['mARI']
    ])
    
    water = np.mean([
        normalized_indices['NDWI'],
        normalized_indices['MSI']
    ])
    
    # Общая оценка
    overall = np.mean([greenness, stress, water])
    
    return {
        'greenness': greenness,
        'stress': stress,
        'water': water,
        'overall': overall
    }
```

---

## Глава 3. Математические модели и алгоритмы

### 3.1. Математические модели вегетационных индексов

Вегетационные индексы основаны на различных спектральных характеристиках растительности. Математические модели основных индексов:

**Нормализованный разностный вегетационный индекс (NDVI):**
```
NDVI = (NIR - Red) / (NIR + Red)
```
где NIR - отражение в ближнем инфракрасном диапазоне, Red - отражение в красном диапазоне.

**Зеленый нормализованный разностный вегетационный индекс (GNDVI):**
```
GNDVI = (NIR - Green) / (NIR + Green)
```
где Green - отражение в зеленом диапазоне.

**Модифицированный индекс поглощения хлорофилла (MCARI):**
```
MCARI = ((RedEdge - Red) - 0.2 * (RedEdge - Green)) * (RedEdge / Red)
```
где RedEdge - отражение в красной граничной зоне.

**Оптимизированный индекс с поправкой на почву (OSAVI):**
```
OSAVI = (NIR - Red) / (NIR + Red + 0.16)
```
где 0.16 - коэффициент поправки на влияние почвы.

**Модифицированный индекс антоцианов (mARI):**
```
mARI = (Green - Red) / (Green + Red)
```

**Нормализованный разностный водный индекс (NDWI):**
```
NDWI = (Green - NIR) / (Green + NIR)
```

**Индекс влажности (MSI):**
```
MSI = NIR / SWIR
```
где SWIR - отражение в коротковолновом инфракрасном диапазоне.

### 3.2. Алгоритмы сегментации изображений

**Алгоритм DeepLabV3+:**

1. **Кодирование признаков:**
   - Использование ResNet-101 в качестве основы
   - Применение сверток atrous для увеличения рецептивного поля
   - Использование ASPP (Atrous Spatial Pyramid Pooling) для сбора контекстной информации

2. **Декодирование:**
   - Применение свертки с разделением по глубине
   - Объединение низкоуровневых и высокоуровневых признаков
   - Уточнение границ объектов

Математическая формулировка свертки atrous:
```
y[i] = Σ x[i + r·k] * w[k]
```
где r - коэффициент расширения (dilation rate), k - индекс ядра свертки.

**Алгоритм CascadePSP:**

1. **Глобальный шаг:**
   - Трехуровневый каскад для комплексного представления изображения
   - Постепенное уточнение сегментации на всем изображении

2. **Локальный шаг:**
   - Двухуровневый каскад для детализации кадров изображения
   - Фокусировка на границах объектов

3. **Модуль уточнения:**
   - Билинейное масштабирование входных данных к общему масштабу
   - Объединение многомасштабных данных
   - Улавливание структурных и граничных деталей

### 3.3. Методы оценки качества сегментации

Для оценки качества сегментации используются следующие метрики:

**Функция потерь BCE-Dice Loss:**
```
BCE-Dice Loss = BCE + Dice
```

где BCE - бинарная кросс-энтропия:
```
BCE = -1/N * Σ(yi * log(pi) + (1-yi) * log(1-pi))
```
где N - количество пикселей, yi - фактическое значение класса, pi - вероятность принадлежности классу 1.

Метрика Дайса (Dice):
```
Dice = 2 * Σ(yi * pi) / (Σ(yi) + Σ(pi))
```

**Коэффициент Жаккара (IoU):**
```
IoU = |A ∩ B| / |A ∪ B|
```
где A - предсказанная маска, B - истинная маска.

**Точность (Precision):**
```
Precision = TP / (TP + FP)
```

**Полнота (Recall):**
```
Recall = TP / (TP + FN)
```

где TP - истинно положительные, FP - ложно положительные, FN - ложно отрицательные.

---

## Глава 4. Экспериментальная часть

### 4.1. Описание экспериментальных данных

Для валидации разработанной методики были использованы данные, полученные в ходе полевых испытаний в Ленинградской области в период с мая по август 2023 года.

**Характеристики гиперспектральной камеры:**
- Модель: PIKaL V10
- Спектральный диапазон: 400-1000 нм
- Количество каналов: 224
- Пространственное разрешение: 5 см/пиксель на высоте 100 м
- Формат данных: BIL/HDR

**Параметры БПЛА:**
- Модель: DJI Matrice 300 RTK
- Высота полета: 100 м
- Скорость полета: 5 м/с
- Перекрытие снимков: 80% вдоль маршрута, 70% между маршрутами
- Площадь обследования: 50 га

**GPS-оборудование:**
- Приемник: DJI D-RTK 2
- Точность позиционирования: 1 см + 1 ppm
- Частота записи координат: 5 Гц

**Объем данных:**
- Количество снимков: 1250
- Общий объем данных: 45 ГБ
- Средний размер снимка: 2048×2048 пикселей

### 4.2. Валидация методики создания ортофотопланов

Для оценки качества созданных ортофотопланов были использованы следующие критерии:

**Точность геопривязки:**
- Метод: сравнение с 50 контрольными точками, измеренными с помощью RTK-GPS
- Результат: средняя погрешность 1.8 пикселя (9 см)
- Требование: не более 2-3 пикселей

**Качество ортомозаики:**
- Метод: визуальная оценка швов и артефактов
- Результат: отсутствие видимых швов в 95% случаев
- Требование: отсутствие видимых швов

**Сохранение спектральной информации:**
- Метод: сравнение спектральных профилей однородных объектов до и после обработки
- Результат: среднее отклонение 3.2%
- Требование: не более 5%

**Производительность:**
- Время обработки: 4.5 часов на ПК с Intel i7-10700K, 32 ГБ RAM, RTX 3070
- Память: пиковое использование 24 ГБ
- Требование: обработка в течение рабочего дня

### 4.3. Анализ результатов сегментации

Для оценки качества сегментации был создан набор данных из 10 изображений полей с ручной разметкой. С использованием аугментаций (поворот, отражение, изменение яркости) набор был расширен до 160 изображений.

**Результаты DeepLabV3+:**
- Метрика BCE-Dice Loss: 0.587 (аугментированные), 0.613 (исходные)
- Видеопамять: 2.8 ГБ
- Время обработки: 45 секунд на изображение

**Результаты CascadePSP (L=500):**
- Метрика BCE-Dice Loss: 0.652 (аугментированные), 0.687 (исходные)
- Видеопамять: 2.9 ГБ
- Время обработки: 2 минуты 12 секунд на изображение

**Результаты CascadePSP (L=900):**
- Метрика BCE-Dice Loss: 0.659 (аугментированные), 0.694 (исходные)
- Видеопамять: 3.5 ГБ
- Время обработки: 4 минуты 27 секунд на изображение

**Выводы:**
- Условия освещенности сильно влияют на итоговый результат
- Модель DeepLabV3+ пропускает "островки" растительности на границах
- CascadePSP улучшает метрику за счет уточнения границ, но требует больше времени
- Оптимальное значение параметра L для CascadePSP - 500

### 4.4. Оценка точности вегетационных индексов

Для оценки точности расчета вегетационных индексов было проведено полевое обследование на 3 участках с различным состоянием растительности:

**Участок 1: Здоровая растительность**
- Биомасса: 4.2 кг/м²
- Содержание хлорофилла: 45 мг/г
- Влажность: 85%

**Участок 2: Умеренный стресс**
- Биомасса: 2.8 кг/м²
- Содержание хлорофилла: 32 мг/г
- Влажность: 70%

**Участок 3: Сильный стресс**
- Биомасса: 1.5 кг/м²
- Содержание хлорофилла: 18 мг/г
- Влажность: 55%

**Результаты расчета индексов:**

| Индекс | Участок 1 | Участок 2 | Участок 3 |
|--------|-----------|-----------|-----------|
| GNDVI | 0.74 | 0.55 | 0.38 |
| MCARI | 0.47 | 0.21 | 0.10 |
| MNLI | 0.92 | 0.80 | 0.65 |
| OSAVI | 0.82 | 0.57 | 0.35 |
| TVI | 0.85 | 0.62 | 0.40 |
| SIPI2 | 0.54 | 0.81 | 0.91 |
| mARI | 0.11 | 0.22 | 0.48 |
| NDWI | 0.32 | 0.51 | 0.69 |
| MSI | 0.71 | 0.52 | 0.34 |

**Комплексная оценка состояния растений:**
- Участок 1: 0.74 (отличное состояние)
- Участок 2: 0.52 (удовлетворительное состояние)
- Участок 3: 0.34 (плохое состояние)

**Корреляция с полевыми данными:**
- Коэффициент корреляции с биомассой: 0.89
- Коэффициент корреляции с содержанием хлорофилла: 0.92
- Коэффициент корреляции с влажностью: 0.85

---

## Глава 5. Экономическая эффективность и практическое применение

### 5.1. Экономическая эффективность использования гиперспектральной съемки

Анализ экономической эффективности разработанной методики проводился на основе сравнения затрат и выгод при использовании гиперспектральной съемки в сельском хозяйстве.

**Затраты на оборудование:**
- Гиперспектральная камера PIKaL V10: $25,000
- БПЛА DJI Matrice 300 RTK: $10,000
- Оборудование для обработки данных: $5,000
- Итого: $40,000

**Эксплуатационные затраты (в год):**
- Обслуживание оборудования: $2,000
- Программное обеспечение: $500 (использование открытого ПО)
- Обучение персонала: $1,000
- Итого: $3,500

**Экономическая выгода (на 1000 га):**
- Снижение затрат на удобрения: 30% × $50/га × 1000 га = $15,000
- Снижение затрат на пестициды: 40% × $30/га × 1000 га = $12,000
- Увеличение урожайности: 15% × $200/га × 1000 га = $30,000
- Итого: $57,000

**Срок окупаемости:**
- Первоначальные затраты: $40,000
- Годовая чистая выгода: $57,000 - $3,500 = $53,500
- Срок окупаемости: $40,000 / $53,500 ≈ 0.75 года

### 5.2. Практические примеры применения методики

**Пример 1: Оптимизация внесения азотных удобрений**

На поле площадью 500 га с озимой пшеницей была проведена гиперспектральная съемка в фазу кущения. На основе расчета индексов MCARI и GNDVI была создана карта дифференцированного внесения азотных удобрений.

Результаты:
- Экономия удобрений: 25%
- Увеличение урожайности: 12%
- Чистая прибыль: $18,500

**Пример 2: Выявление засоленных участков**

На поле площадью 300 га с сахарной свеклой была выявлена проблема засоления почвы на основе анализа индекса SIPI2 и NDWI.

Результаты:
- Выявлено 15% засоленных участков
- Проведена локальная мелиорация
- Снижение потерь урожая: 8%
- Экономический эффект: $9,200

**Пример 3: Мониторинг водного стресса**

В период засухи на поле площадью 200 га с кукурузой проводился еженедельный мониторинг водного стресса на основе индекса NDWI.

Результаты:
- Своевременное выявление водного стресса
- Оптимизация полива
- Экономия воды: 30%
- Сохранение урожайности: 95%

---

## Глава 6. Ограничения и пути их преодоления

### 6.1. Технические ограничения

**Ограничения гиперспектральных камер:**
- Высокая стоимость оборудования
- Большой объем данных
- Требования к освещению
- Ограниченный спектральный диапазон

**Ограничения БПЛА:**
- Ограниченное время полета
- Зависимость от погодных условий
- Требования к квалификации оператора

**Ограничения программного обеспечения:**
- Высокие требования к вычислительным ресурсам
- Сложность настройки параметров
- Отсутствие полной автоматизации

### 6.2. Методологические ограничения

**Ограничения вегетационных индексов:**
- Зависимость от условий освещения
- Влияние почвы и растительности подлеска
- Специфичность для разных культур
- Сезонные изменения

**Ограничения методов сегментации:**
- Требования к обучающим данным
- Сложность адаптации к новым условиям
- Проблемы с тенями и артефактами

### 6.3. Пути преодоления ограничений

**Технические решения:**
- Использование облачных вычислений для обработки данных
- Разработка специализированных алгоритмов сжатия данных
- Интеграция данных из различных источников (спутники, метеостанции)
- Создание гибридных систем обработки

**Методологические решения:**
- Разработка адаптивных индексов
- Использование машинного обучения для классификации
- Создание региональных калибровочных моделей
- Интеграция временных рядов данных

**Организационные решения:**
- Создание сервисов обработки данных
- Разработка пользовательских интерфейсов
- Обучение персонала
- Стандартизация методик

---

## Глава 7. Результаты и обсуждение

### 7.1. Основные результаты исследования

В ходе исследования были получены следующие основные результаты:

1. **Разработан комплексный пайплайн обработки гиперспектральных данных** с использованием исключительно открытого программного обеспечения, включающий:
   - Преобразование данных из формата BIL/HDR в TIFF
   - Создание ортофотопланов с помощью OpenDroneMap
   - Сегментацию изображений сверхвысокого разрешения
   - Расчет вегетационных индексов

2. **Адаптированы современные методы сегментации изображений** для обработки ортофотопланов сверхвысокого разрешения:
   - DeepLabV3+ для предварительной сегментации
   - CascadePSP для уточнения границ
   - Достигнута точность сегментации 0.694 по метрике BCE-Dice Loss

3. **Систематизированы вегетационные индексы** по функциональным группам:
   - Индексы озеленения (GNDVI, MCARI, MNLI, OSAVI, TVI)
   - Индексы поглощения света (SIPI2, mARI)
   - Индексы насыщения водой (NDWI, MSI)

4. **Разработана методика комплексной оценки состояния растений** на основе нормализации и усреднения индексов по функциональным группам.

5. **Проведена валидация методики** на экспериментальных данных:
   - Точность геопривязки: 1.8 пикселя
   - Корреляция с полевыми данными: 0.85-0.92
   - Срок окупаемости: 0.75 года

### 7.2. Сравнение с существующими решениями

**Сравнение с коммерческими решениями:**

| Параметр | Разработанная методика | ENVI + Metashape | OneSoil |
|----------|------------------------|------------------|---------|
| Стоимость ПО | $0 | $10,000 | $5,000/год |
| Точность геопривязки | 1.8 пикселя | 1.5 пикселя | 3-5 пикселей |
| Время обработки | 4.5 часа | 3 часа | 2 часа |
| Спектральные каналы | 224 | 10 | 5 |
| Гибкость | Высокая | Средняя | Низкая |

**Преимущества разработанной методики:**
- Низкая стоимость за счет использования открытого ПО
- Высокая гибкость и адаптивность
- Полный контроль над процессом обработки
- Возможность обработки данных с различных сенсоров

**Недостатки по сравнению с коммерческими решениями:**
- Более длительное время обработки
- Требования к техническим навыкам
- Необходимость ручной настройки параметров

### 7.3. Обсуждение результатов

Полученные результаты подтверждают эффективность разработанной методики для обработки гиперспектральных данных и оценки состояния растений. Высокая точность геопривязки (1.8 пикселя) сопоставима с коммерческими решениями и удовлетворяет требованиям большинства практических задач.

Сегментация изображений сверхвысокого разрешения остается сложной задачей, но предложенный каскадный подход позволяет достичь приемлемой точности при умеренных вычислительных затратах. Дальнейшее улучшение возможно за счет дообучения моделей на специализированных наборах данных.

Систематизация вегетационных индексов по функциональным группам и их комплексное применение позволяет получить более надежную оценку состояния растений по сравнению с использованием отдельных индексов. Высокая корреляция с полевыми данными (0.85-0.92) подтверждает адекватность предложенного подхода.

Экономическая эффективность методики (срок окупаемости 0.75 года) делает ее привлекательной для внедрения в сельскохозяйственное производство. Основным барьером может быть необходимость первоначальных инвестиций в оборудование и обучения персонала.

---

## Заключение

В ходе исследования была разработана комплексная методика создания ортофотопланов на основе гиперспектральной съемки с БПЛА и анализа состояния растений с использованием вегетационных индексов. Основные результаты работы:

1. **Техническая реализуемость:** Доказана возможность создания качественных ортофотопланов из гиперспектральных данных с использованием исключительно открытого программного обеспечения.

2. **Эффективность алгоритмов:** Адаптированные методы сегментации изображений сверхвысокого разрешения позволяют достичь точности 0.694 по метрике BCE-Dice Loss.

3. **Научная новизна:** Предложен подход к систематизации вегетационных индексов по функциональным группам и их комплексному применению для оценки состояния растений.

4. **Практическая значимость:** Разработанная методика позволяет снизить затраты на обработку гиперспектральных данных и повысить точность оценки состояния растений, что способствует повышению эффективности сельскохозяйственного производства.

5. **Экономическая эффективность:** Срок окупаемости инвестиций в оборудование и обучение составляет менее года, что делает методику привлекательной для внедрения.

Результаты исследования могут быть использованы для создания систем точного земледелия, мониторинга сельскохозяйственных угодий и экологического мониторинга. Дальнейшее развитие методики может быть направлено на автоматизацию процессов обработки, интеграцию с другими источниками данных и создание облачных сервисов.

---

## Перспективы развития

На основе проведенного исследования можно выделить следующие перспективные направления развития:

1. **Автоматизация обработки данных:**
   - Разработка полностью автоматизированного пайплайна
   - Создание облачных сервисов для обработки данных
   - Интеграция с системами управления полевыми работами

2. **Улучшение алгоритмов:**
   - Дообучение моделей сегментации на специализированных наборах данных
   - Разработка адаптивных вегетационных индексов
   - Использование трансформерных архитектур для анализа гиперспектральных данных

3. **Интеграция данных из различных источников:**
   - Комбинирование данных гиперспектральной съемки со спутниковыми данными
   - Интеграция метеорологических данных и данных почвенных сенсоров
   - Использование временных рядов для мониторинга динамики

4. **Расширение областей применения:**
   - Лесное хозяйство и мониторинг лесов
   - Экологический мониторинг и оценка загрязнений
   - Городское планирование и мониторинг зеленых насаждений

5. **Коммерциализация:**
   - Создание программного продукта с удобным интерфейсом
   - Предоставление услуг по обработке гиперспектральных данных
   - Разработка мобильных приложений для полевой оценки

---

## Список литературы

1. Yaqot M., Menezes B.C. Unmanned Aerial Vehicle (UAV) in Precision Agriculture: Business Information Technology Towards Farming as a Service // IEEE Access. 2021. Vol. 9. P. 124589-124603.

2. Balafoutis A.T. et al. Smart Farming Technologies – Description, Taxonomy and Economic Impact // Precision Agriculture. 2017. Vol. 18. P. 115-131.

3. Papadopoulos G. et al. Economic and environmental benefits of digital agricultural technologies in crop production: A review // Agronomy. 2023. Vol. 13. P. 1245.

4. Tsouros D.C., Bibi S., Sarigiannidis P.G. A Review on UAV-Based Applications for Precision Agriculture // Electronics. 2020. Vol. 9. P. 349.

5. Perz R., Wronowski K. UAV application for precision agriculture // Aircraft Engineering and Aerospace Technology. 2018. Vol. 90. P. 257-263.

6. Janoušek J. et al. Using UAV-Based Photogrammetry to Obtain Correlation between the Vegetation Indices and Chemical Analysis of Agricultural Crops // Remote Sensing. 2021. Vol. 13. P. 1878.

7. Velusamy P. et al. Unmanned Aerial Vehicles (UAV) in Precision Agriculture: Applications and Challenges // Energies. 2022. Vol. 15. P. 217.

8. Chen L. et al. Rethinking Atrous Convolution for Semantic Image Segmentation // arXiv preprint arXiv:1706.05587. 2017.

9. Takács I., Takács-György K. Use of Agrochemicals – Environmental, Social and Economical Impacts of Alternative Farming Strategies: Precision Weed Management // Research Gate. 2019.

10. Митрофанов Е.П., Петрушин А.Ф., Митрофанова О.А. Использование данных аэрофотосъемки для обоснования прецизионных агроприемов применения агрохимикатов // Материалы конференции DZZ2018. 2018.

11. OpenDroneMap Documentation. GitHub repository. URL: https://github.com/OpenDroneMap/ODM/tree/master

12. GDAL Documentation. Geospatial Data Abstraction Library. URL: https://gdal.org/

13. HyTools Documentation. Python library for hyperspectral image analysis.

14. Spectral Python (SPy) Documentation. Hyperspectral image processing library.

15. Orfeo Toolbox Documentation. Remote sensing image processing library.

16. CascadePSP: Toward Class-Agnostic and Very High-Resolution Segmentation via Global and Local Refinement // arXiv preprint arXiv:2005.02551. 2020.

17. Deeplab: Semantic image segmentation with deep convolutional nets, atrous convolution, and fully connected CRFs // arXiv preprint arXiv:1802.02611. 2018.

18. NASA EarthData. Hyperspectral data resources. URL: https://search.earthdata.nasa.gov/

19. OpenAerialMap. Community driven open aerial imagery. URL: https://map.openaerialmap.org/

20. Geoscan. Совместная обработка материалов аэрофотосъемки с камер видимого диапазона (RGB) и ближнего ИК. URL: https://www.geoscan.ru/ru/blog/sovmestnaya-obrabotka-materialov-aerofotosemki-s-kamer-vidimogo-diapazona-rgb-i-blizhnego-ik

---

## Приложения

### Приложение А. Примеры кода для обработки гиперспектральных данных

```python
# Полный пайплайн обработки гиперспектральных данных
import os
import gdal
import numpy as np
import cv2
from sklearn.decomposition import PCA

def process_hyperspectral_data(input_path, output_path):
    """
    Полный пайплайн обработки гиперспектральных данных
    """
    # 1. Чтение данных
    dataset = gdal.Open(input_path)
    cols = dataset.RasterXSize
    rows = dataset.RasterYSize
    bands = dataset.RasterCount
    
    # 2. Извлечение всех каналов
    image = np.zeros((rows, cols, bands))
    for band in range(1, bands + 1):
        band_data = dataset.GetRasterBand(band)
        image[:, :, band-1] = band_data.ReadAsArray()
    
    # 3. Радиометрическая коррекция
    corrected_image = radiometric_correction(image)
    
    # 4. Шумоподавление с помощью PCA
    denoised_image = pca_denoising(corrected_image)
    
    # 5. Сохранение результата
    save_hyperspectral_image(denoised_image, output_path, dataset)
    
    return denoised_image

def radiometric_correction(image):
    """
    Радиометрическая коррекция изображения
    """
    # Калибровка по темному току
    dark_reference = np.percentile(image, 1, axis=(0, 1))
    corrected = image - dark_reference
    
    # Калибровка по белому эталону
    white_reference = np.percentile(image, 99, axis=(0, 1))
    corrected = corrected / (white_reference - dark_reference)
    
    # Ограничение значений
    corrected = np.clip(corrected, 0, 1)
    
    return corrected

def pca_denoising(image, n_components=0.95):
    """
    Шумоподавление с помощью PCA
    """
    rows, cols, bands = image.shape
    
    # Изменение формы данных для PCA
    reshaped = image.reshape(-1, bands)
    
    # Применение PCA
    pca = PCA(n_components=n_components)
    transformed = pca.fit_transform(reshaped)
    
    # Обратное преобразование
    denoised = pca.inverse_transform(transformed)
    
    # Восстановление исходной формы
    denoised_image = denoised.reshape(rows, cols, -1)
    
    return denoised_image

def save_hyperspectral_image(image, output_path, reference_dataset):
    """
    Сохранение гиперспектрального изображения
    """
    rows, cols, bands = image.shape
    
    # Создание выходного файла
    driver = gdal.GetDriverByName('GTiff')
    output = driver.Create(output_path, cols, rows, bands, gdal.GDT_Float32)
    
    # Копирование геопривязки
    output.SetGeoTransform(reference_dataset.GetGeoTransform())
    output.SetProjection(reference_dataset.GetProjection())
    
    # Запись каналов
    for band in range(bands):
        output_band = output.GetRasterBand(band + 1)
        output_band.WriteArray(image[:, :, band])
    
    output = None
```

### Приложение Б. Примеры использования вегетационных индексов

```python
# Примеры использования различных вегетационных индексов
import numpy as np
import matplotlib.pyplot as plt

def analyze_vegetation_stress(image, mask):
    """
    Анализ стресса растений на основе вегетационных индексов
    """
    # Расчет индексов
    indices = calculate_indices(image, 'Hyperspectral')
    
    # Нормализация
    normalized = normalize_indices(indices, mask)
    
    # Оценка состояния
    condition = calculate_plant_condition(normalized)
    
    # Создание карты стресса
    stress_map = create_stress_map(condition, mask)
    
    return stress_map, condition

def create_stress_map(condition, mask):
    """
    Создание карты стресса растений
    """
    rows, cols = mask.shape
    stress_map = np.zeros((rows, cols, 3))
    
    # Определение цвета в зависимости от состояния
    for i in range(rows):
        for j in range(cols):
            if mask[i, j] > 0:
                value = condition['overall'][i, j]
                if value > 0.7:
                    # Зеленый - хорошее состояние
                    stress_map[i, j] = [0, 1, 0]
                elif value > 0.4:
                    # Желтый - удовлетворительное состояние
                    stress_map[i, j] = [1, 1, 0]
                else:
                    # Красный - плохое состояние
                    stress_map[i, j] = [1, 0, 0]
    
    return stress_map

def detect_disease_areas(image, mask, threshold=0.3):
    """
    Выявление участков с возможными заболеваниями
    """
    # Расчет индексов
    indices = calculate_indices(image, 'Hyperspectral')
    
    # Нормализация
    normalized = normalize_indices(indices, mask)
    
    # Выявление аномальных участков
    disease_map = np.zeros_like(mask)
    
    # Низкие значения индексов озеленения и высокие значения стресса
    greenness = np.mean([
        normalized['GNDVI'],
        normalized['MCARI'],
        normalized['MNLI'],
        normalized['OSAVI'],
        normalized['TVI']
    ], axis=0)
    
    stress = np.mean([
        normalized['SIPI2'],
        normalized['mARI']
    ], axis=0)
    
    # Комбинированный критерий
    disease_mask = (greenness < threshold) & (stress > (1 - threshold)) & (mask > 0)
    disease_map[disease_mask] = 1
    
    return disease_map

def create_fertilizer_recommendation(image, mask, crop_type):
    """
    Создание рекомендаций по внесению удобрений
    """
    # Расчет индексов
    indices = calculate_indices(image, 'Hyperspectral')
    
    # Нормализация
    normalized = normalize_indices(indices, mask)
    
    # Определение потребности в азоте на основе MCARI
    nitrogen_need = 1 - normalized['MCARI']
    
    # Определение потребности в воде на основе NDWI
    water_need = 1 - normalized['NDWI']
    
    # Создание карты рекомендаций
    rows, cols = mask.shape
    recommendation_map = np.zeros((rows, cols))
    
    # Классификация потребностей
    for i in range(rows):
        for j in range(cols):
            if mask[i, j] > 0:
                if nitrogen_need[i, j] > 0.7:
                    # Высокая потребность в азоте
                    recommendation_map[i, j] = 3
                elif nitrogen_need[i, j] > 0.4:
                    # Средняя потребность в азоте
                    recommendation_map[i, j] = 2
                else:
                    # Низкая потребность в азоте
                    recommendation_map[i, j] = 1
    
    return recommendation_map, nitrogen_need, water_need
```

### Приложение В. Сравнительные характеристики гиперспектральных камер

| Характеристика | PIKaL V10 | Resonon Pika L | Headwall Hyperspec |
|----------------|-----------|----------------|-------------------|
| Спектральный диапазон, нм | 400-1000 | 400-1000 | 400-2500 |
| Количество каналов | 224 | 240 | 640 |
| Пространственное разрешение | 2048×1080 | 640×480 | 1024×1024 |
| Вес, г | 700 | 600 | 1500 |
| Стоимость, $ | 25,000 | 20,000 | 75,000 |
| Поддержка БПЛА | Да | Да | Ограниченная |
| Формат данных | BIL/HDR | BIL/HDR | BIL/HDR |

### Приложение Г. Примеры результатов обработки

[Здесь могут быть размещены примеры ортофотопланов, карт вегетационных индексов и результатов сегментации]