# Тестирование и CI/CD для проекта GOP

Этот документ описывает систему тестирования и непрерывной интеграции/развертывания (CI/CD) для проекта GOP (Гиперспектральная обработка и анализ растений).

## Обзор системы тестирования

### Структура тестов

Проект использует многоуровневую систему тестирования:

1. **Модульные тесты** - Тестирование отдельных функций и классов
2. **Интеграционные тесты** - Тестирование взаимодействия между компонентами
3. **Тесты CLI** - Тестирование командной строки интерфейса
4. **Тесты утилит** - Тестирование вспомогательных функций

### Покрытие кода

- **Целевое покрытие**: 70%
- **Инструменты**: pytest-cov, coverage.py
- **Отчеты**: HTML, XML, терминальный вывод

## Запуск тестов локально

### Подготовка окружения

```bash
# Клонирование репозитория
git clone <repository-url>
cd GOP

# Создание виртуального окружения
python -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate  # Windows

# Установка зависимостей
pip install -r requirements.txt
pip install -r requirements-dev.txt
pip install -e .
```

### Запуск всех тестов

```bash
# Используя pytest (рекомендуется)
pytest tests/ --cov=src --cov-report=html --cov-report=term-missing

# Используя встроенный скрипт
python tests/run_tests.py

# Используя unittest
python -m unittest discover tests/
```

### Запуск конкретных тестов

```bash
# Конкретный модуль
pytest tests/test_config.py

# Конкретный тест
pytest tests/test_config.py::TestConfig::test_config_initialization

# С маркерами
pytest tests/ -m "not slow"  # Только быстрые тесты
pytest tests/ -m integration  # Только интеграционные тесты
```

## CI/CD pipeline

### GitHub Actions

Проект использует GitHub Actions для автоматизации тестирования и развертывания.

#### Воркфлоу

1. **Тестирование** (`.github/workflows/test.yml`)
   - Матричное тестирование на разных ОС (Ubuntu, Windows, macOS)
   - Матричное тестирование на разных версиях Python (3.8-3.11)
   - Линтинг кода (flake8, black, isort)
   - Проверка типов (mypy)
   - Запуск тестов с покрытием
   - Интеграционные тесты
   - Проверка безопасности (bandit, safety)

2. **Качество кода** (`.github/workflows/quality.yml`)
   - Проверка форматирования (black, isort)
   - Линтинг (flake8, pylint)
   - Анализ сложности (radon, xenon)
   - Проверка безопасности (bandit, safety)
   - Анализ кода (SonarCloud, CodeQL)

3. **Покрытие кода** (`.github/workflows/coverage.yml`)
   - Генерация отчетов о покрытии
   - Загрузка в Codecov
   - Сравнение покрытия с базовой веткой
   - Комментарии в PR с информацией о покрытии

4. **Релиз** (`.github/workflows/release.yml`)
   - Сборка пакета
   - Публикация на PyPI и Test PyPI
   - Создание Docker образа
   - Развертывание документации
   - Создание GitHub Release

### Триггеры

- **Push** в ветки `main` и `develop`
- **Pull Request** в ветки `main` и `develop`
- **Создание тега** (для релиза)

## Качество кода

### Инструменты

- **Форматирование**: black
- **Сортировка импортов**: isort
- **Линтинг**: flake8, pylint
- **Проверка типов**: mypy
- **Анализ сложности**: radon, xenon
- **Безопасность**: bandit, safety

### Конфигурация

#### black

```ini
[tool.black]
line-length = 127
target-version = ['py38', 'py39', 'py310', 'py311']
include = '\.pyi?$'
extend-exclude = '''
/(
  # directories
  \.eggs
  | \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | build
  | dist
)/
'''
```

#### isort

```ini
[tool.isort]
profile = "black"
multi_line_output = 3
line_length = 127
```

#### flake8

```ini
[flake8]
max-line-length = 127
extend-ignore = E203, W503
exclude = .git,__pycache__,docs/source/conf.py,old,build,dist
```

#### mypy

```ini
[mypy]
python_version = 3.8
warn_return_any = True
warn_unused_configs = True
ignore_missing_imports = True
no_strict_optional = True
```

## Тестирование в Docker

### Сборка образа

```bash
# Базовый образ
docker build -t gop:latest .

# Образ для разработки
docker build --target development -t gop:dev .

# GPU образ
docker build --target gpu -t gop:gpu .
```

### Запуск тестов в Docker

```bash
# Запуск тестов
docker run --rm -v $(pwd):/app gop:latest pytest tests/

# Запуск с покрытием
docker run --rm -v $(pwd):/app gop:latest pytest tests/ --cov=src --cov-report=html
```

## Метрики и отчетность

### Покрытие кода

- **Codecov**: Автоматическая загрузка отчетов
- **Порог**: 70% минимальное покрытие
- **Интеграция**: Комментарии в PR с информацией о покрытии

### Качество кода

- **SonarCloud**: Анализ кода и технический долг
- **CodeQL**: Анализ безопасности
- **Bandit**: Проверка на уязвимости в Python коде

### Производительность

- **Время выполнения тестов**: Мониторинг в CI
- **Использование памяти**: Профилирование в тестах
- **Параллельное выполнение**: pytest-xdist для ускорения

## Стратегия тестирования

### Пирамида тестирования

```
    E2E тесты (мало)
   ─────────────────
  Интеграционные тесты
 ─────────────────────────
Модульные тесты (много)
```

### Типы тестов

1. **Модульные тесты** (~70%)
   - Быстрое выполнение
   - Изолированные тесты
   - Мокирование внешних зависимостей

2. **Интеграционные тесты** (~20%)
   - Тестирование взаимодействия компонентов
   - Использование реальных зависимостей
   - Тестирование API и баз данных

3. **E2E тесты** (~10%)
   - Тестирование полного пользовательского пути
   - Тестирование CLI интерфейса
   - Тестирование с реальными данными

### Тестирование данных

- **Синтетические данные**: Генерируются в тестах
- **Фикстуры**: Предопределенные наборы данных
- **Мокирование**: Имитация внешних систем

## Лучшие практики

### Написание тестов

1. **AAA паттерн**: Arrange, Act, Assert
2. **Описательные имена**: Тесты должны описывать сценарий
3. **Изоляция**: Каждый тест должен быть независимым
4. **Повторяемость**: Тесты должны давать одинаковые результаты
5. **Быстрое выполнение**: Избегайте задержек в тестах

### Пример хорошего теста

```python
def test_calculate_gndvi_with_valid_data_returns_correct_index(self):
    """
    Тест расчета GNDVI с валидными данными возвращает корректный индекс
    """
    # Arrange
    nir_band = np.array([[0.8, 0.7], [0.6, 0.5]])
    green_band = np.array([[0.3, 0.4], [0.5, 0.6]])
    expected = np.array([[0.45, 0.27], [0.09, -0.09]])
    
    # Act
    result = calculate_gndvi(nir_band, green_band)
    
    # Assert
    np.testing.assert_array_almost_equal(result, expected, decimal=2)
```

### Управление тестовыми данными

1. **Фикстуры**: Используйте pytest fixtures для повторного использования данных
2. **Фабрики**: Создавайте тестовые данные программно
3. **Очистка**: Удаляйте временные файлы и ресурсы после тестов

## Непрерывная интеграция

### Ветвление

- **main**: Стабильная версия, готовая к релизу
- **develop**: Версия в разработке
- **feature/***: Ветки для новых функций
- **hotfix/***: Ветки для исправлений

### Процесс

1. **Разработка** в feature ветке
2. **Pull Request** в develop
3. **Автоматические тесты** и проверки качества
4. **Code Review** и утверждение
5. **Слияние** в develop
6. **Релиз** из develop в main

### Автоматизация

- **Тесты**: Запускаются при каждом push и PR
- **Качество**: Проверяется автоматически
- **Релиз**: Автоматическая публикация при создании тега
- **Документация**: Автоматическое обновление

## Мониторинг и отчетность

### Дашборды

- **GitHub Actions**: Статус сборок и тестов
- **Codecov**: Покрытие кода
- **SonarCloud**: Качество кода
- **PyPI**: Статистика загрузок

### Оповещения

- **Email**: Уведомления об ошибках в CI
- **Slack**: Интеграция с GitHub (опционально)
- **GitHub**: Комментарии в PR с результатами

## Устранение неполадок

### Распространенные проблемы

1. **Тесты падают в CI, но работают локально**
   - Проверьте версии зависимостей
   - Проверьте системные зависимости
   - Изучите логи CI

2. **Низкое покрытие кода**
   - Добавьте тесты для непокрытых участков
   - Используйте `coverage report --show-missing`
   - Рассмотрите рефакторинг сложного кода

3. **Медленные тесты**
   - Используйте моки для внешних зависимостей
   - Параллельное выполнение с pytest-xdist
   - Оптимизация тестовых данных

### Отладка

```bash
# Подробный вывод
pytest tests/ -v -s

# Остановка при первой ошибке
pytest tests/ -x

# Запуск только упавших тестов
pytest tests/ --lf

# Локальное выполнение CI
act -j test
```

## Будущее развитие

### Планы улучшения

1. **Расширение покрытия** до 85%
2. **Добавление E2E тестов** с реальными данными
3. **Тестирование производительности** (бенчмарки)
4. **Визуальная регрессия** для графиков и изображений
5. **Тестирование на GPU** для вычислительных функций

### Инструменты

- **pytest-benchmark**: Тестирование производительности
- **pytest-xdist**: Параллельное выполнение
- **pytest-mock**: Улучшенное мокирование
- **hypothesis**: Тестирование на основе свойств

## Заключение

Система тестирования и CI/CD для проекта GOP обеспечивает:

- **Высокое качество кода** через автоматические проверки
- **Стабильность** через комплексное тестирование
- **Быструю доставку** через автоматизацию
- **Прозрачность** через подробную отчетность

Эта система позволяет команде разрабатывать с уверенностью, зная, что изменения не нарушат существующую функциональность.